import{X as R,C as j,D as k,l as b,u as m,m as t,o as T,z as i,E as L,y as A,F as E,t as I,A as V,O as H,M as B}from"./vendor-LkufkiF7.js";import{L as U}from"./Layout-DdwsTprQ.js";import{_ as z}from"./RichEditor-CzXGCwgg.js";import{a as D,h as P}from"./utils-Cv2kkzzw.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{Loader2 as N,LucideSend as O,LucideRefreshCw as q,ArrowLeft as F}from"./ui-DZ0wy3Ge.js";import"./LogoutButton-CfMbGx4V.js";import"./app-BMhdMQxL.js";import"./Logo-CwTRbPbO.js";import"./FlashMessages-Bge5XBye.js";const X={name:"ConversationView",components:{Link:j,Head:R,RichEditor:z,ArrowLeft:F,RefreshCw:q,Send:O,Loader2:N},layout:U,props:{conversation:{type:Object,required:!0},user:{type:Object,required:!0},availableUsers:{type:Array,default:()=>[]}},data(){return{moment:P,newMessage:"",sending:!1,refreshing:!1,localMessages:[],hasLocalMessages:!1}},computed:{messages(){var e;return this.hasLocalMessages?this.localMessages:((e=this.conversation)==null?void 0:e.messages)||[]}},watch:{"conversation.messages":{handler(e){e&&Array.isArray(e)&&(this.localMessages=[...e],this.hasLocalMessages=!0)},immediate:!0,deep:!0}},mounted(){var e;this.localMessages=Array.isArray((e=this.conversation)==null?void 0:e.messages)?[...this.conversation.messages]:[],this.hasLocalMessages=!0,this.scrollToBottom(),this.setupKeyboardShortcuts()},beforeUnmount(){this.removeKeyboardShortcuts()},methods:{getInitials(e){return e?e.split(" ").map(s=>s.charAt(0)).join("").toUpperCase().substring(0,2):"U"},formatMessage(e){if(!e)return"";let s=e.replace(/\n/g,"<br>");const l=/(https?:\/\/[^\s]+)/g;s=s.replace(l,'<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline">$1</a>');const f=/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;return s=s.replace(f,'<a href="mailto:$1" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline">$1</a>'),s},onMessageChange(e){this.newMessage=e},setupKeyboardShortcuts(){this.keydownHandler=e=>{e.ctrlKey&&e.key==="Enter"&&(e.preventDefault(),this.sendMessage())},document.addEventListener("keydown",this.keydownHandler)},removeKeyboardShortcuts(){this.keydownHandler&&document.removeEventListener("keydown",this.keydownHandler)},getConversationTypeBadgeClass(e){return e==="internal"?"bg-slate-100 text-slate-800 dark:bg-slate-600 dark:text-slate-200":"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300"},getParticipantColor(e){switch(e){case"customer":return"bg-blue-500";case"agent":return"bg-green-500";case"participant":return"bg-purple-500";default:return"bg-slate-500"}},getMessageUserColor(e){return e===this.user.id?"bg-blue-500":"bg-slate-500"},getRoleLabel(e){switch(e){case"customer":return this.$t("Customer");case"agent":return this.$t("Agent");case"participant":return this.$t("Participant");default:return this.$t("User")}},async sendMessage(){var o,_,w,y,M,C,v,x,a,h;if(!this.newMessage.trim()||this.sending)return;const e="conversation-editor-"+this.conversation.id,s=(o=window.tinymce)==null?void 0:o.get(e),l=s?s.getContent():this.newMessage;if(!l.trim())return;const f=l;let n=null;this.sending=!0;try{this.newMessage="",s&&s.setContent(""),n={id:Date.now(),message:f,user:this.user,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},this.localMessages.push(n),this.$nextTick(()=>{this.scrollToBottom()});const r=await D.post(route("conversations.send-message",this.conversation.id),{message:l},{headers:{Accept:"application/json","Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}});if(r.data&&r.data.success){if(console.log("Message sent successfully via API:",r.data),r.data.data){const d=r.data.data,c=this.localMessages.findIndex(u=>u.id===n.id);c!==-1&&(this.localMessages[c]={...n,id:d.id||n.id,created_at:d.created_at||n.created_at,updated_at:d.updated_at||n.updated_at})}}else throw new Error(((_=r.data)==null?void 0:_.message)||((w=r.data)==null?void 0:w.error)||"Failed to send message")}catch(r){if(console.error("Error sending message:",r),console.error("Error details:",{message:r.message,response:(y=r.response)==null?void 0:y.data,status:(M=r.response)==null?void 0:M.status}),n){const g=this.localMessages.findIndex(p=>{var S;return p.id===n.id&&((S=p.user)==null?void 0:S.id)===this.user.id});g!==-1&&this.localMessages.splice(g,1)}this.newMessage=f;const d="conversation-editor-"+this.conversation.id,c=(C=window.tinymce)==null?void 0:C.get(d);c&&c.setContent(f);const u=((x=(v=r.response)==null?void 0:v.data)==null?void 0:x.message)||((h=(a=r.response)==null?void 0:a.data)==null?void 0:h.error)||r.message||"Failed to send message. Please try again.";alert("Error sending message: "+u)}finally{this.sending=!1}},async refreshConversation(){this.refreshing=!0;try{await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error("Error refreshing conversation:",e)}finally{this.refreshing=!1}},scrollToBottom(){this.$nextTick(()=>{this.$refs.messagesContainer&&(this.$refs.messagesContainer.scrollTop=this.$refs.messagesContainer.scrollHeight)})},goBack(){try{window.history.length>1?window.history.back():this.navigateToTicket()}catch(e){console.warn("History back failed, using fallback navigation:",e),this.navigateToTicket()}},navigateToTicket(){var s;const e=(s=this.conversation.ticket)==null?void 0:s.uid;e?this.$inertia.visit(route("tickets.show",e),{preserveState:!1,preserveScroll:!1,replace:!1}):this.$inertia.visit(route("tickets.index"),{preserveState:!1,preserveScroll:!1,replace:!1})}}},Z={class:"min-h-screen bg-slate-50 dark:bg-slate-900"},W={class:"bg-white dark:bg-slate-800 shadow-sm border-b border-slate-200 dark:border-slate-700"},G={class:"px-6 py-4"},J={class:"flex items-center justify-between"},Q={class:"flex items-center gap-4"},Y={class:"text-xl font-semibold text-slate-900 dark:text-white"},$={class:"text-sm text-slate-500 dark:text-slate-400"},ee={class:"flex items-center gap-2"},te={class:"flex h-[calc(100vh-80px)]"},se={class:"w-72 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col"},ae={class:"p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50"},re={class:"text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2"},oe={class:"flex-1 overflow-y-auto p-4 space-y-3"},ne={class:"relative"},ie={key:0,class:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-slate-800"},le={class:"flex-1 min-w-0"},de={class:"text-sm font-medium text-slate-900 dark:text-white truncate"},ce={class:"text-xs text-slate-500 dark:text-slate-400"},ue={class:"flex-1 flex flex-col min-w-0"},he={ref:"messagesContainer",class:"flex-1 overflow-y-auto p-6 space-y-6 messages-container bg-slate-50/50 dark:bg-slate-900/50"},ge={class:"flex-1 min-w-0"},me={class:"flex items-center gap-3 mb-2"},fe={class:"text-sm font-semibold text-slate-900 dark:text-white"},be={class:"text-xs text-slate-500 dark:text-slate-400"},ve=["innerHTML"],xe={class:"border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 shadow-lg"},pe={class:"space-y-3"},ke={class:"rich-editor-container"},_e={class:"flex items-center justify-between"},we={class:"flex items-center gap-3"},ye={class:"text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"},Me={class:"ml-1"},Ce=["disabled"];function Le(e,s,l,f,n,o){var v,x;const _=k("ArrowLeft"),w=k("RefreshCw"),y=k("RichEditor"),M=k("Send"),C=k("Loader2");return m(),b("div",Z,[t("div",W,[t("div",G,[t("div",J,[t("div",Q,[t("button",{onClick:s[0]||(s[0]=(...a)=>o.goBack&&o.goBack(...a)),class:"p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"},[T(_,{class:"w-5 h-5"})]),t("div",null,[t("h1",Y,i(e.$t("Conversation"))+" #"+i(l.conversation.id),1),t("p",$,i(e.$t("Ticket"))+" #"+i((v=l.conversation.ticket)==null?void 0:v.uid)+" - "+i((x=l.conversation.ticket)==null?void 0:x.subject),1)])]),t("div",ee,[t("span",{class:L(["inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",o.getConversationTypeBadgeClass(l.conversation.type)])},i(l.conversation.type==="internal"?e.$t("Internal"):e.$t("Customer")),3),t("button",{onClick:s[1]||(s[1]=(...a)=>o.refreshConversation&&o.refreshConversation(...a)),class:"p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"},[T(w,{class:L(["w-4 h-4",{"animate-spin":n.refreshing}])},null,8,["class"])])])])])]),t("div",te,[t("div",se,[t("div",ae,[t("h3",re,[s[4]||(s[4]=t("div",{class:"w-2 h-2 bg-green-500 rounded-full"},null,-1)),A(" "+i(e.$t("Participants"))+" ("+i(l.conversation.participants.length)+") ",1)])]),t("div",oe,[(m(!0),b(E,null,I(l.conversation.participants,a=>{var h,r,d,c,u,g;return m(),b("div",{key:a.id,class:"flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"},[t("div",ne,[t("div",{class:L(["w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-semibold shadow-sm",o.getParticipantColor(a.role)])},i(o.getInitials(((h=a.user)==null?void 0:h.name)||((r=a.user)==null?void 0:r.first_name)+" "+((d=a.user)==null?void 0:d.last_name))),3),a.user_id===l.user.id?(m(),b("div",ie)):V("",!0)]),t("div",le,[t("p",de,i(((c=a.user)==null?void 0:c.name)||((u=a.user)==null?void 0:u.first_name)+" "+((g=a.user)==null?void 0:g.last_name)),1),t("p",ce,i(o.getRoleLabel(a.role)),1)])])}),128))])]),t("div",ue,[t("div",he,[(m(!0),b(E,null,I(o.messages,a=>{var h,r,d,c,u,g,p;return m(),b("div",{key:a.id,class:"flex gap-4 message-item group"},[t("div",{class:L(["w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-semibold flex-shrink-0 shadow-sm",o.getMessageUserColor((h=a.user)==null?void 0:h.id)])},i(o.getInitials(((r=a.user)==null?void 0:r.name)||((d=a.user)==null?void 0:d.first_name)+" "+((c=a.user)==null?void 0:c.last_name))),3),t("div",ge,[t("div",me,[t("span",fe,i(((u=a.user)==null?void 0:u.name)||((g=a.user)==null?void 0:g.first_name)+" "+((p=a.user)==null?void 0:p.last_name)),1),t("span",be,i(n.moment(a.created_at).format("MMM D, h:mm A")),1),s[5]||(s[5]=H('<div class="flex-1" data-v-c143eebd></div><div class="opacity-0 group-hover:opacity-100 transition-opacity" data-v-c143eebd><button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1 rounded" data-v-c143eebd><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-c143eebd><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" data-v-c143eebd></path></svg></button></div>',2))]),t("div",{class:"message-content prose dark:prose-invert max-w-none text-sm bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700",innerHTML:o.formatMessage(a.message)},null,8,ve)])])}),128))],512),t("div",xe,[t("div",pe,[t("div",ke,[T(y,{modelValue:n.newMessage,"onUpdate:modelValue":[s[2]||(s[2]=a=>n.newMessage=a),o.onMessageChange],id:"conversation-editor-"+l.conversation.id,height:150,compact:!0,toolbar:"undo redo | bold italic underline | emoticons | link | bullist numlist | removeformat",plugins:"emoticons link lists",placeholder:e.$t("Type a message...")},null,8,["modelValue","id","placeholder","onUpdate:modelValue"])]),t("div",_e,[t("div",we,[t("div",ye,[s[6]||(s[6]=t("kbd",{class:"px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs border border-slate-200 dark:border-slate-600"},"Ctrl",-1)),s[7]||(s[7]=t("span",null,"+",-1)),s[8]||(s[8]=t("kbd",{class:"px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs border border-slate-200 dark:border-slate-600"},"Enter",-1)),t("span",Me,i(e.$t("to send")),1)])]),t("button",{type:"button",onClick:s[3]||(s[3]=(...a)=>o.sendMessage&&o.sendMessage(...a)),disabled:!n.newMessage.trim()||n.sending,class:"px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md font-medium"},[n.sending?(m(),B(C,{key:1,class:"w-4 h-4 animate-spin"})):(m(),B(M,{key:0,class:"w-4 h-4"})),A(" "+i(e.$t("Send")),1)],8,Ce)])])])])])])}const Ue=K(X,[["render",Le],["__scopeId","data-v-c143eebd"]]);export{Ue as default};
