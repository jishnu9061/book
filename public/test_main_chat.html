<!DOCTYPE html>
<html>
<head>
    <title>Main Chat Test</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://unpkg.com/laravel-echo@1.15.3/dist/echo.iife.js"></script>
</head>
<body>
    <h1>Main Chat Test - Simulating Your App</h1>
    <div id="status"></div>
    <div id="messages"></div>
    
    <script>
        // Simulate your exact app setup
        const echoConfig = {
            broadcaster: 'pusher',
            key: '09f0300b6461c4fc8605',
            cluster: 'ap1',
            forceTLS: true,
            enabledTransports: ['ws', 'wss'],
            disableStats: false,
        };

        window.Echo = new Echo(echoConfig);
        
        // Simulate PusherManager
        window.PusherManager = {
            echo: window.Echo,
            connectionStatus: 'connected',
            chatCallbacks: new Map(),
            
            listenToChat(conversationId, callback) {
                const channelName = `chat.${conversationId}`;
                const eventName = 'NewChatMessage';
                
                console.log(`Setting up chat listener for ${channelName}`);
                this.log(`Setting up chat listener for ${channelName}`);
                
                this.chatCallbacks.set(conversationId, callback);
                
                if (this.echo) {
                    this.echo.channel(channelName)
                        .listen(eventName, (data) => {
                            console.log(`Received ${eventName} on ${channelName}:`, data);
                            this.log(`Received ${eventName}: ${JSON.stringify(data)}`);
                            callback(data);
                        });
                }
            },
            
            log(message) {
                const statusDiv = document.getElementById('status');
                const time = new Date().toLocaleTimeString();
                statusDiv.innerHTML += `<p>${time}: ${message}</p>`;
            }
        };
        
        // Simulate the exact message handling from your app
        function simulatePushMessage(message) {
            console.log('Processing new message:', message);
            
            // Simulate the sanitizeMessage function
            const sanitizedMessage = {
                id: message.id,
                message: message.message,
                conversation_id: message.conversation_id,
                user_id: message.user_id,
                contact_id: message.contact_id,
                created_at: message.created_at,
                updated_at: message.updated_at,
                user: message.user,
                contact: message.contact
            };
            
            // Add to messages display
            const messagesDiv = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            const senderName = sanitizedMessage.user ? 
                `${sanitizedMessage.user.first_name} ${sanitizedMessage.user.last_name}` : 
                `${sanitizedMessage.contact.first_name} ${sanitizedMessage.contact.last_name}`;
            
            messagesDiv.innerHTML += `
                <div style="border: 1px solid #ccc; margin: 5px; padding: 10px; border-radius: 5px;">
                    <strong>${time} - ${senderName}:</strong> ${sanitizedMessage.message}
                </div>
            `;
        }
        
        // Set up the listener exactly like your app
        setTimeout(() => {
            window.PusherManager.listenToChat(17, (e) => {
                console.log('Received chat message:', e);
                if (typeof e.chatMessage === 'object') {
                    simulatePushMessage(e.chatMessage);
                }
            });
            
            window.PusherManager.log('Main chat test setup complete for conversation 17');
        }, 2000);
    </script>
</body>
</html>

