<!DOCTYPE html>
<html>
<head>
    <title>PusherManager Test</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://unpkg.com/laravel-echo@1.15.3/dist/echo.iife.js"></script>
</head>
<body>
    <h1>PusherManager Test</h1>
    <div id="status"></div>
    <div id="messages"></div>
    
    <script>
        // Simulate your exact app setup
        const echoConfig = {
            broadcaster: 'pusher',
            key: '09f0300b6461c4fc8605',
            cluster: 'ap1',
            forceTLS: true,
            enabledTransports: ['ws', 'wss'],
            disableStats: false,
        };

        window.Echo = new Echo(echoConfig);
        
        // Simulate PusherManager exactly like your app
        window.PusherManager = {
            echo: window.Echo,
            connectionStatus: 'disconnected',
            chatCallbacks: new Map(),
            typingCallbacks: new Map(),
            
            init() {
                console.log('PusherManager: Initializing...');
                this.log('PusherManager: Initializing...');
                
                if (this.echo) {
                    this.setupConnectionMonitoring();
                    this.connectionStatus = 'connected';
                    this.log('PusherManager: Initialized successfully');
                } else {
                    this.log('PusherManager: Echo not available');
                }
            },
            
            setupConnectionMonitoring() {
                if (this.echo && this.echo.connector && this.echo.connector.pusher) {
                    const pusher = this.echo.connector.pusher;
                    
                    pusher.connection.bind('connected', () => {
                        this.connectionStatus = 'connected';
                        this.log('Pusher: Connected! Socket ID: ' + pusher.connection.socket_id);
                    });
                    
                    pusher.connection.bind('connecting', () => {
                        this.connectionStatus = 'connecting';
                        this.log('Pusher: Connecting...');
                    });
                    
                    pusher.connection.bind('disconnected', () => {
                        this.connectionStatus = 'disconnected';
                        this.log('Pusher: Disconnected');
                    });
                    
                    pusher.connection.bind('error', (error) => {
                        this.connectionStatus = 'error';
                        this.log('Pusher Error: ' + JSON.stringify(error));
                    });
                }
            },
            
            listenToChat(conversationId, callback) {
                const channelName = `chat.${conversationId}`;
                const eventName = 'NewChatMessage';
                
                console.log(`PusherManager: Setting up chat listener for ${channelName}`);
                this.log(`Setting up chat listener for ${channelName}`);
                
                this.chatCallbacks.set(conversationId, callback);
                
                if (this.echo) {
                    this.echo.channel(channelName)
                        .listen(eventName, (data) => {
                            console.log(`PusherManager: Received ${eventName} on ${channelName}:`, data);
                            this.log(`Received ${eventName}: ${JSON.stringify(data)}`);
                            callback(data);
                        });
                }
            },
            
            getConnectionStatus() {
                return this.connectionStatus;
            },
            
            log(message) {
                const statusDiv = document.getElementById('status');
                const time = new Date().toLocaleTimeString();
                statusDiv.innerHTML += `<p>${time}: ${message}</p>`;
            }
        };
        
        // Initialize PusherManager
        window.PusherManager.init();
        
        // Test chat listener
        setTimeout(() => {
            window.PusherManager.listenToChat(17, (data) => {
                const messagesDiv = document.getElementById('messages');
                const time = new Date().toLocaleTimeString();
                messagesDiv.innerHTML += `<p><strong>${time}:</strong> ${JSON.stringify(data)}</p>`;
            });
            
            window.PusherManager.log('Chat listener set up for conversation 17');
        }, 2000);
    </script>
</body>
</html>

